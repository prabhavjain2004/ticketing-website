<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Updated Iframe Parsing Test</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">Updated Iframe URL Extraction Test</h1>
        
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Test the Updated Implementation</h2>
            
            <!-- Test Input -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    Paste iframe code or direct URL:
                </label>
                <textarea 
                    id="sponsor-embed-input-0" 
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" 
                    rows="4"
                    placeholder="Paste your Google Drive iframe code or direct URL here..."
                ></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    You can paste either the iframe code or direct Google Drive URL
                </p>
            </div>
            
            <!-- Hidden Django form field simulation -->
            <div style="position: absolute; left: -9999px; opacity: 0;">
                <input 
                    type="url" 
                    name="sponsors-0-logo_url" 
                    id="id_sponsors-0-logo_url"
                    class="form-input"
                    required
                >
            </div>
            
            <!-- Test Button -->
            <div class="mb-4">
                <button 
                    type="button" 
                    class="test-sponsor-url bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors" 
                    data-form-index="0"
                >
                    Test URL
                </button>
            </div>
            
            <!-- Status indicators -->
            <div id="url-extraction-status-0" class="text-xs mb-2"></div>
            <div class="sponsor-url-status-0 text-xs mb-4"></div>
            
            <!-- Preview container -->
            <div class="sponsor-logo-preview-container-0 mt-3 hidden">
                <p class="text-sm font-medium text-gray-700 mb-2">Preview:</p>
                <img class="sponsor-logo-preview-0 h-32 rounded-lg border border-gray-200 shadow-sm" src="" alt="Logo preview">
            </div>
            
            <!-- Debug info -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">Debug Info:</h3>
                <div class="text-xs text-gray-600">
                    <p>Hidden Input Value: <span id="debug-hidden-value" class="font-mono bg-white px-1 rounded">empty</span></p>
                </div>
            </div>
            
            <!-- Example iframe code for testing -->
            <div class="mt-8 p-4 bg-blue-50 rounded-lg">
                <h3 class="text-lg font-semibold text-blue-800 mb-2">Test Examples</h3>
                
                <div class="mb-4">
                    <p class="text-sm text-blue-700 mb-2">Example 1 - Iframe code:</p>
                    <code class="block text-xs bg-white p-2 rounded border text-gray-700 break-all">
&lt;iframe src="https://drive.google.com/file/d/1d5QaRjbjRitdxFTGm_V5SJvNdEjgEQIO/preview" width="640" height="480" allow="autoplay"&gt;&lt;/iframe&gt;
                    </code>
                </div>
                
                <div class="mb-4">
                    <p class="text-sm text-blue-700 mb-2">Example 2 - Direct URL:</p>
                    <code class="block text-xs bg-white p-2 rounded border text-gray-700 break-all">
https://drive.google.com/file/d/1d5QaRjbjRitdxFTGm_V5SJvNdEjgEQIO/view
                    </code>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Copy the functions from the main implementation
        function extractUrlFromInput(input) {
            if (!input) return null;
            
            // First, check if it's an iframe
            const iframeMatch = input.match(/<iframe[^>]*src="([^"]*)"[^>]*>/i);
            if (iframeMatch) {
                return iframeMatch[1]; // Return the src URL
            }
            
            // If not iframe, check if it's a direct URL
            const urlPattern = /https?:\/\/[^\s<>"]+/i;
            const urlMatch = input.match(urlPattern);
            if (urlMatch) {
                return urlMatch[0];
            }
            
            return null;
        }
        
        function validateGoogleDriveUrl(url) {
            const googleDrivePatterns = [
                /drive\.google\.com\/file\/d\/([a-zA-Z0-9-_]+)/,
                /drive\.google\.com\/open\?id=([a-zA-Z0-9-_]+)/,
                /googleusercontent\.com/
            ];
            
            return googleDrivePatterns.some(pattern => pattern.test(url));
        }
        
        function extractGoogleDriveId(url) {
            // Check if it's an iframe first
            const iframeMatch = url.match(/<iframe[^>]*src="([^"]*)"[^>]*>/i);
            if (iframeMatch) {
                // Extract the URL from iframe src and then extract ID from that
                url = iframeMatch[1];
            }
            
            const patterns = [
                /\/d\/([a-zA-Z0-9-_]+)/,  // https://drive.google.com/file/d/FILE_ID/view or /preview
                /id=([a-zA-Z0-9-_]+)/,    // https://drive.google.com/open?id=FILE_ID
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }
        
        function testGoogleDriveUrl(url, statusElement, previewElement, previewContainer) {
            if (!url) {
                statusElement.innerHTML = '';
                if (previewContainer) previewContainer.classList.add('hidden');
                return;
            }
            
            const fileId = extractGoogleDriveId(url);
            if (!fileId) {
                statusElement.innerHTML = '<span class="text-red-600">‚ùå Invalid Google Drive URL format</span>';
                if (previewContainer) previewContainer.classList.add('hidden');
                return;
            }
            
            statusElement.innerHTML = '<span class="text-blue-600">üîÑ Testing URL...</span>';
            
            // Use the more reliable LH3 URL format first
            const lh3Url = `https://lh3.googleusercontent.com/d/${fileId}=w800`;
            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
            
            const testImg = new Image();
            
            testImg.onload = function() {
                statusElement.innerHTML = '<span class="text-green-600">‚úÖ Image accessible and ready to use</span>';
                if (previewElement && previewContainer) {
                    previewElement.src = lh3Url;
                    previewContainer.classList.remove('hidden');
                }
            };
            
            testImg.onerror = function() {
                // Try thumbnail URL as fallback
                const fallbackImg = new Image();
                fallbackImg.onload = function() {
                    statusElement.innerHTML = '<span class="text-green-600">‚úÖ Image accessible via thumbnail URL</span>';
                    if (previewElement && previewContainer) {
                        previewElement.src = thumbnailUrl;
                        previewContainer.classList.remove('hidden');
                    }
                };
                fallbackImg.onerror = function() {
                    statusElement.innerHTML = '<span class="text-red-600">‚ùå Image not publicly accessible. Please check sharing permissions.</span>';
                    if (previewContainer) previewContainer.classList.add('hidden');
                };
                fallbackImg.src = thumbnailUrl;
            };
            
            testImg.src = lh3Url;
        }
        
        function processEmbedInput(index) {
            const embedInput = document.getElementById(`sponsor-embed-input-${index}`);
            const hiddenUrlInput = document.querySelector(`input[name="sponsors-${index}-logo_url"]`);
            const statusElement = document.getElementById(`url-extraction-status-${index}`);
            const testStatusElement = document.querySelector(`.sponsor-url-status-${index}`);
            const previewElement = document.querySelector(`.sponsor-logo-preview-${index}`);
            const previewContainer = document.querySelector(`.sponsor-logo-preview-container-${index}`);
            const debugElement = document.getElementById('debug-hidden-value');
            
            if (!embedInput || !hiddenUrlInput) {
                console.log('Could not find elements for index:', index);
                return;
            }
            
            const inputValue = embedInput.value.trim();
            
            if (!inputValue) {
                hiddenUrlInput.value = '';
                if (statusElement) statusElement.innerHTML = '';
                if (testStatusElement) testStatusElement.innerHTML = '';
                if (previewContainer) previewContainer.classList.add('hidden');
                if (debugElement) debugElement.textContent = 'empty';
                return;
            }
            
            const extractedUrl = extractUrlFromInput(inputValue);
            
            if (extractedUrl) {
                if (validateGoogleDriveUrl(extractedUrl)) {
                    hiddenUrlInput.value = extractedUrl;
                    if (statusElement) {
                        statusElement.innerHTML = '<span class="text-green-600">‚úÖ URL extracted successfully</span>';
                    }
                    if (debugElement) debugElement.textContent = extractedUrl;
                    
                    // Automatically test the extracted URL
                    if (testStatusElement && previewElement && previewContainer) {
                        testGoogleDriveUrl(extractedUrl, testStatusElement, previewElement, previewContainer);
                    }
                } else {
                    hiddenUrlInput.value = '';
                    if (statusElement) {
                        statusElement.innerHTML = '<span class="text-red-600">‚ùå Not a valid Google Drive URL</span>';
                    }
                    if (previewContainer) previewContainer.classList.add('hidden');
                    if (debugElement) debugElement.textContent = 'invalid URL';
                }
            } else {
                hiddenUrlInput.value = '';
                if (statusElement) {
                    statusElement.innerHTML = '<span class="text-red-600">‚ùå Could not extract URL from input</span>';
                }
                if (previewContainer) previewContainer.classList.add('hidden');
                if (debugElement) debugElement.textContent = 'no URL found';
            }
        }
        
        // Event listeners
        document.addEventListener('input', function(e) {
            if (e.target.id && e.target.id.startsWith('sponsor-embed-input-')) {
                const index = e.target.id.replace('sponsor-embed-input-', '');
                processEmbedInput(index);
            }
        });
        
        document.addEventListener('paste', function(e) {
            if (e.target.id && e.target.id.startsWith('sponsor-embed-input-')) {
                const index = e.target.id.replace('sponsor-embed-input-', '');
                setTimeout(() => processEmbedInput(index), 100);
            }
        });
        
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('test-sponsor-url')) {
                e.preventDefault();
                const formIndex = e.target.dataset.formIndex;
                
                const hiddenUrlInput = document.querySelector(`input[name="sponsors-${formIndex}-logo_url"]`);
                const statusElement = document.querySelector(`.sponsor-url-status-${formIndex}`);
                const previewElement = document.querySelector(`.sponsor-logo-preview-${formIndex}`);
                const previewContainer = document.querySelector(`.sponsor-logo-preview-container-${formIndex}`);
                
                if (hiddenUrlInput && statusElement) {
                    const url = hiddenUrlInput.value;
                    if (!url) {
                        statusElement.innerHTML = '<span class="text-red-600">‚ùå No URL found. Please paste iframe code or URL first.</span>';
                        return;
                    }
                    testGoogleDriveUrl(url, statusElement, previewElement, previewContainer);
                } else {
                    console.log('Could not find elements for form index:', formIndex);
                }
            }
        });
    </script>
</body>
</html>
