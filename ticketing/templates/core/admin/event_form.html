{% extends 'core/admin/base_admin.html' %}
{% load static %}
{% load ticketing_extras %}

{% block admin_content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">{{ action }} Event</h1>
                    <p class="mt-2 text-sm text-gray-600">
                        {% if action == "Create" %}
                            Create a new event with ticket types and sponsors
                        {% else %}
                            Update event details, ticket types, and sponsors
                        {% endif %}
                    </p>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'admin_event_list' %}" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                        Back to Events
                    </a>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Event Form -->
            <div class="lg:col-span-2">
                <form method="post" enctype="multipart/form-data" id="eventForm" class="space-y-8">
                    {% csrf_token %}
                    
                    <!-- Basic Information Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-3">
                            <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Basic Information
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Event Title <span class="text-red-500">*</span>
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.title.errors }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.event_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Event Type <span class="text-red-500">*</span>
                                </label>
                                {{ form.event_type }}
                                {% if form.event_type.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.event_type.errors }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-span-2">
                            <label for="{{ form.short_description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Short Description
                            </label>
                            {{ form.short_description }}
                            {% if form.short_description.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.short_description.errors }}</p>
                            {% endif %}
                            <p class="text-xs text-gray-500 mt-1">Brief summary for event listings and previews</p>
                        </div>
                        
                        <div class="col-span-2">
                            <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Full Description <span class="text-red-500">*</span>
                            </label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.description.errors }}</p>
                            {% endif %}
                            <p class="text-xs text-gray-500 mt-1">Detailed description that will appear on the event page</p>
                        </div>
                    </div>

                    <!-- Banner Image Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-3">
                            <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Event Banner Image
                        </h3>
                        
                        <div>
                            <label for="{{ form.banner_image_url.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                Banner Image URL or Iframe Code
                            </label>
                            <div class="relative">
                                {{ form.banner_image_url }}
                                <button type="button" id="test-banner-url" 
                                        class="absolute right-3 top-3 text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-1 bg-blue-50 rounded transition-colors">
                                    Test URL
                                </button>
                            </div>
                            {% if form.banner_image_url.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.banner_image_url.errors }}</p>
                            {% endif %}
                            <div id="banner-url-status" class="text-xs mt-2"></div>
                            
                            <!-- Google Drive Help -->
                            <details class="mt-3">
                                <summary class="text-sm text-blue-600 cursor-pointer hover:text-blue-800 font-medium">
                                    üìñ How to get a Google Drive link?
                                </summary>
                                <div class="mt-3 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <div class="text-sm text-gray-700">
                                        <p class="font-medium mb-2">Two easy options:</p>
                                        <div class="space-y-3">
                                            <div>
                                                <p class="font-medium text-green-600">Option 1: Regular URL</p>
                                                <ol class="list-decimal list-inside space-y-1 text-sm ml-4">
                                                    <li>Upload your image to Google Drive</li>
                                                    <li>Right-click the file and select "Share"</li>
                                                    <li><strong>IMPORTANT:</strong> Change permissions to "Anyone with the link can view"</li>
                                                    <li>Copy the link and paste it in the field</li>
                                                </ol>
                                            </div>
                                            <div>
                                                <p class="font-medium text-blue-600">Option 2: Iframe Code (Recommended)</p>
                                                <ol class="list-decimal list-inside space-y-1 text-sm ml-4">
                                                    <li>Upload your image to Google Drive</li>
                                                    <li><strong>IMPORTANT:</strong> Right-click ‚Üí Share ‚Üí "Anyone with the link can view"</li>
                                                    <li>Open the image and click "Embed item" or "Preview"</li>
                                                    <li>Copy the entire iframe code</li>
                                                    <li>Paste the complete iframe code in the field</li>
                                                </ol>
                                            </div>
                                        </div>
                                        <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
                                            <p class="text-sm font-medium text-yellow-800">üîì Sharing Requirements:</p>
                                            <p class="text-xs text-yellow-700 mt-1">The Google Drive file MUST be set to "Anyone with the link can view" for it to display properly on your website.</p>
                                        </div>
                                        <div class="mt-3">
                                            <p class="font-medium text-gray-800">Supported formats:</p>
                                            <div class="text-xs bg-gray-100 p-3 rounded mt-1 space-y-2">
                                                <div>
                                                    <p class="font-medium text-green-600">URLs:</p>
                                                    <p class="font-mono">https://drive.google.com/file/d/FILE_ID/view</p>
                                                    <p class="font-mono">https://drive.google.com/open?id=FILE_ID</p>
                                                </div>
                                                <div>
                                                    <p class="font-medium text-blue-600">Iframe codes:</p>
                                                    <p class="font-mono break-all">&lt;iframe src="https://drive.google.com/file/d/FILE_ID/preview" width="640" height="480"&gt;&lt;/iframe&gt;</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </details>
                            
                            <!-- Banner Preview -->
                            {% if event and event.banner_image_url %}
                                <div class="mt-4">
                                    <p class="text-sm font-medium text-gray-700 mb-2">Current Banner:</p>
                                    {% google_drive_image event.banner_image_url "Event banner" "h-32 rounded-lg border border-gray-200 shadow-sm" %}
                                </div>
                            {% else %}
                                <div id="banner-preview-container" class="mt-4 hidden">
                                    <p class="text-sm font-medium text-gray-700 mb-2">Preview:</p>
                                    <img id="banner-preview" src="" alt="Banner preview" 
                                         class="h-32 rounded-lg border border-gray-200 shadow-sm">
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Event Schedule & Location Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-3">
                            <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Event Schedule & Location
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Start Date <span class="text-red-500">*</span>
                                </label>
                                {{ form.date }}
                                {% if form.date.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.date.errors }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.end_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    End Date
                                </label>
                                {{ form.end_date }}
                                {% if form.end_date.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.end_date.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Leave blank for single-day events</p>
                            </div>
                            
                            <div>
                                <label for="{{ form.time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Start Time <span class="text-red-500">*</span>
                                </label>
                                {{ form.time }}
                                {% if form.time.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.time.errors }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.end_time.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    End Time
                                </label>
                                {{ form.end_time }}
                                {% if form.end_time.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.end_time.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Optional end time</p>
                            </div>
                        </div>
                        
                        <div class="mt-6 space-y-4">
                            <div>
                                <label for="{{ form.venue.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Venue Name <span class="text-red-500">*</span>
                                </label>
                                {{ form.venue }}
                                {% if form.venue.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.venue.errors }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.venue_address.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Venue Address
                                </label>
                                {{ form.venue_address }}
                                {% if form.venue_address.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.venue_address.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Full address including city, state, and postal code</p>
                            </div>
                            
                            <div>
                                <label for="{{ form.venue_map_link.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Venue Map Link
                                </label>
                                {{ form.venue_map_link }}
                                {% if form.venue_map_link.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.venue_map_link.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Google Maps link or other mapping service URL</p>
                            </div>
                        </div>
                    </div>
                    <!-- Event Settings Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-3">
                            <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Event Settings
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="{{ form.capacity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Total Capacity <span class="text-red-500">*</span>
                                </label>
                                {{ form.capacity }}
                                {% if form.capacity.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.capacity.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Maximum number of attendees</p>
                            </div>
                            
                            <div>
                                <label for="{{ form.registration_deadline.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Registration Deadline
                                </label>
                                {{ form.registration_deadline }}
                                {% if form.registration_deadline.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.registration_deadline.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Last date and time for registration</p>
                            </div>
                            
                            <div>
                                <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Event Status <span class="text-red-500">*</span>
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.status.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Only published events are visible to customers</p>
                            </div>
                            
                            <div class="flex items-start">
                                <div class="flex items-center h-5 mt-7">
                                    {{ form.featured }}
                                </div>
                                <div class="ml-3 text-sm mt-6">
                                    <label for="{{ form.featured.id_for_label }}" class="font-medium text-gray-700">
                                        Featured Event
                                    </label>
                                    <p class="text-gray-500 text-xs">Featured events appear prominently on the homepage</p>
                                    {% if form.featured.errors %}
                                        <p class="text-red-500 text-xs mt-1">{{ form.featured.errors }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Terms & Conditions Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-3">
                            <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Terms & Conditions
                        </h3>
                        
                        <div class="space-y-6">
                            <div>
                                <label for="{{ form.venue_terms.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Venue Terms
                                </label>
                                {{ form.venue_terms }}
                                {% if form.venue_terms.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.venue_terms.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Venue-specific rules and regulations</p>
                            </div>
                            
                            <div>
                                <label for="{{ form.event_terms.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Event Terms
                                </label>
                                {{ form.event_terms }}
                                {% if form.event_terms.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.event_terms.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Event-specific terms and conditions</p>
                            </div>
                            
                            <div>
                                <label for="{{ form.restrictions.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                                    Restrictions
                                </label>
                                {{ form.restrictions }}
                                {% if form.restrictions.errors %}
                                    <p class="text-red-500 text-xs mt-1">{{ form.restrictions.errors }}</p>
                                {% endif %}
                                <p class="text-xs text-gray-500 mt-1">Age restrictions, accessibility information, etc.</p>
                            </div>
                        </div>
                    </div>
                    <!-- Event Sponsors Section -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-3">
                            <svg class="w-5 h-5 inline mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                            </svg>
                            Event Sponsors
                        </h3>
                        
                        <div id="sponsors-section">
                            <div class="space-y-6" id="sponsors-container">
                                <!-- Django formset management form -->
                                <input type="hidden" name="sponsors-TOTAL_FORMS" value="0" id="id_sponsors-TOTAL_FORMS">
                                <input type="hidden" name="sponsors-INITIAL_FORMS" value="0" id="id_sponsors-INITIAL_FORMS">
                                <input type="hidden" name="sponsors-MIN_NUM_FORMS" value="0" id="id_sponsors-MIN_NUM_FORMS">
                                <input type="hidden" name="sponsors-MAX_NUM_FORMS" value="1000" id="id_sponsors-MAX_NUM_FORMS">
                                
                                <!-- Sponsors will be added dynamically using the "Add Sponsor" button -->
                            </div>
                            
                            <!-- Add Sponsor Section -->
                            <div class="mt-8 p-6 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg border-2 border-dashed border-blue-200">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                            <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                            Add Event Sponsors
                                        </h4>
                                        <p class="text-sm text-gray-600 mt-1">Click the button below to add sponsors to your event. You can add multiple sponsors with different types and display orders.</p>
                                    </div>
                                    <button type="button" id="add-sponsor-btn" class="bg-gradient-to-r from-green-600 to-blue-600 text-white px-8 py-3 rounded-lg hover:from-green-700 hover:to-blue-700 flex items-center font-semibold shadow-lg transition-all duration-200 hover:shadow-xl transform hover:-translate-y-0.5">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                        Add Sponsor
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Actions -->
                    <div class="bg-white rounded-lg shadow-sm p-6">
                        <div class="flex justify-between items-center">
                            <a href="{% url 'admin_event_list' %}" 
                               class="inline-flex items-center px-6 py-3 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Cancel
                            </a>
                            <button type="submit" 
                                    class="inline-flex items-center px-8 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-200 transform hover:-translate-y-0.5 hover:shadow-lg">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                {{ action }} Event
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Sidebar - Ticket Types Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-sm p-6 sticky top-8">
                    <h3 class="text-lg font-semibold text-gray-900 mb-6 border-b border-gray-200 pb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                        </svg>
                        Ticket Types
                    </h3>
                    
                    {% if event %}
                        <!-- List existing ticket types -->
                        <div class="space-y-4 mb-6">
                            {% for ticket_type in event.ticket_types.all %}
                                <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 hover:border-gray-300 transition-colors">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="font-semibold text-gray-800">{{ ticket_type.type_name }}</h4>
                                        <span class="text-lg font-bold text-green-600">‚Çπ{{ ticket_type.price }}</span>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2 text-sm text-gray-600 mb-3">
                                        <span class="flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                                            </svg>
                                            {{ ticket_type.quantity }} tickets
                                        </span>
                                        <span class="flex items-center">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                            {{ ticket_type.attendees_per_ticket }} attendee(s)
                                        </span>
                                    </div>
                                    {% if ticket_type.description %}
                                        <p class="text-xs text-gray-500 mb-3">{{ ticket_type.description|truncatewords:15 }}</p>
                                    {% endif %}
                                    <div class="flex justify-end space-x-2">
                                        <a href="{% url 'admin_edit_ticket_type' ticket_type.id %}" 
                                           class="text-blue-600 text-sm hover:text-blue-800 font-medium">Edit</a>
                                        <a href="{% url 'admin_delete_ticket_type' ticket_type.id %}" 
                                           class="text-red-600 text-sm hover:text-red-800 font-medium" 
                                           onclick="return confirm('Are you sure you want to delete this ticket type?')">Delete</a>
                                    </div>
                                </div>
                            {% empty %}
                                <div class="text-center py-8">
                                    <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path>
                                    </svg>
                                    <p class="text-gray-500 text-sm">No ticket types defined yet</p>
                                    <p class="text-xs text-gray-400 mt-1">Add ticket types to start selling tickets</p>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Add new ticket type buttons -->
                        <div class="space-y-3">
                            <a href="{% url 'admin_create_ticket_type' %}?event_id={{ event.id }}" 
                               class="block w-full text-center bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium transition-colors shadow-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Add Ticket Type
                            </a>
                            <!-- Quick Add Modal Trigger -->
                            <button id="quickAddTicketTypeBtn" 
                                    class="block w-full text-center bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium transition-colors shadow-sm">
                                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                                Quick Add Ticket Type
                            </button>
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <svg class="w-12 h-12 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                            </svg>
                            <p class="text-gray-500 text-sm font-medium">Save the event first</p>
                            <p class="text-xs text-gray-400 mt-1">Then you can add ticket types</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Ticket Type Modal -->
{% if event %}
<div id="ticketTypeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
        <div class="flex justify-between items-center p-6 border-b border-gray-200">
            <h3 class="text-xl font-semibold text-gray-900 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Quick Add Ticket Type
            </h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <form id="quickTicketTypeForm" class="p-6 space-y-4">
            {% csrf_token %}
            <input type="hidden" name="event" value="{{ event.id }}">
            
            <div>
                <label for="type_name" class="block text-sm font-medium text-gray-700 mb-2">
                    Ticket Type Name <span class="text-red-500">*</span>
                </label>
                <input type="text" id="type_name" name="type_name" required 
                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                       placeholder="e.g., General Admission, VIP, Early Bird">
            </div>
            
            <div>
                <label for="price" class="block text-sm font-medium text-gray-700 mb-2">
                    Price <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">‚Çπ</span>
                    <input type="number" id="price" name="price" step="0.01" required 
                           class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 pl-8 pr-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="0.00">
                </div>
            </div>
            
            <div>
                <label for="quantity" class="block text-sm font-medium text-gray-700 mb-2">
                    Quantity Available
                </label>
                <input type="number" id="quantity" name="quantity" min="1"
                       class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                       placeholder="e.g., 100">
                <p class="text-gray-500 text-xs mt-1">Maximum number of tickets available for sale</p>
            </div>
            
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
                    Description
                </label>
                <textarea id="description" name="description" rows="3" 
                          class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                          placeholder="Brief description of what's included with this ticket type..."></textarea>
            </div>
            
            <div>
                <label for="attendees_per_ticket" class="block text-sm font-medium text-gray-700 mb-2">
                    Attendees Per Ticket
                </label>
                <select id="attendees_per_ticket" name="attendees_per_ticket" 
                        class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    <option value="1">1 attendee per ticket</option>
                    <option value="2">2 attendees per ticket</option>
                    <option value="4">4 attendees per ticket</option>
                    <option value="6">6 attendees per ticket</option>
                    <option value="8">8 attendees per ticket</option>
                </select>
                <p class="text-gray-500 text-xs mt-1">Number of people allowed entry with each ticket</p>
            </div>
            
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" id="cancelModal"
                        class="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    Cancel
                </button>
                <button type="submit" 
                        class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                    Add Ticket Type
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    // Google Drive URL utility functions
    function extractGoogleDriveId(url) {
        // Check if it's an iframe first
        const iframeMatch = url.match(/<iframe[^>]*src="([^"]*)"[^>]*>/i);
        if (iframeMatch) {
            // Extract the URL from iframe src and then extract ID from that
            url = iframeMatch[1];
        }
        
        const patterns = [
            /\/d\/([a-zA-Z0-9-_]+)/,  // https://drive.google.com/file/d/FILE_ID/view or /preview
            /id=([a-zA-Z0-9-_]+)/,    // https://drive.google.com/open?id=FILE_ID
        ];
        
        for (const pattern of patterns) {
            const match = url.match(pattern);
            if (match) return match[1];
        }
        return null;
    }
    
    function getGoogleDriveDirectUrl(fileId) {
        return `https://drive.google.com/uc?id=${fileId}`;
    }
    
    function testGoogleDriveUrl(url, statusElement, previewElement, previewContainer) {
        if (!url) {
            statusElement.innerHTML = '';
            if (previewContainer) previewContainer.classList.add('hidden');
            return;
        }
        
        const fileId = extractGoogleDriveId(url);
        if (!fileId) {
            statusElement.innerHTML = '<span class="text-red-600">‚ùå Invalid Google Drive URL format</span>';
            if (previewContainer) previewContainer.classList.add('hidden');
            return;
        }
        
        statusElement.innerHTML = '<span class="text-blue-600">üîÑ Testing URL...</span>';
        
        // Use the more reliable LH3 URL format first
        const lh3Url = `https://lh3.googleusercontent.com/d/${fileId}=w800`;
        const thumbnailUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w800`;
        
        const testImg = new Image();
        
        testImg.onload = function() {
            statusElement.innerHTML = '<span class="text-green-600">‚úÖ Image accessible and ready to use</span>';
            if (previewElement && previewContainer) {
                previewElement.src = lh3Url;
                previewContainer.classList.remove('hidden');
            }
        };
        
        testImg.onerror = function() {
            // Try thumbnail URL as fallback
            const fallbackImg = new Image();
            fallbackImg.onload = function() {
                statusElement.innerHTML = '<span class="text-green-600">‚úÖ Image accessible via thumbnail URL</span>';
                if (previewElement && previewContainer) {
                    previewElement.src = thumbnailUrl;
                    previewContainer.classList.remove('hidden');
                }
            };
            fallbackImg.onerror = function() {
                statusElement.innerHTML = '<span class="text-red-600">‚ùå Image not publicly accessible. Please check sharing permissions.</span>';
                if (previewContainer) previewContainer.classList.add('hidden');
            };
            fallbackImg.src = thumbnailUrl;
        };
        
        // Test the LH3 URL first (most reliable)
        testImg.src = lh3Url;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Simple and robust event delegation for sponsor test buttons
        document.addEventListener('click', function(e) {
            // Check if clicked element or its parent is a test-sponsor-url button
            let button = null;
            if (e.target.classList.contains('test-sponsor-url')) {
                button = e.target;
                console.log('Direct button click detected');
            } else if (e.target.closest('.test-sponsor-url')) {
                button = e.target.closest('.test-sponsor-url');
                console.log('Parent button click detected');
            }
            
            if (button) {
                e.preventDefault();
                e.stopPropagation();
                
                const formIndex = button.getAttribute('data-form-index');
                console.log('SPONSOR TEST BUTTON CLICKED - Form index:', formIndex);
                
                if (formIndex !== null && formIndex !== undefined) {
                    // Show immediate feedback
                    const statusElement = document.querySelector(`.sponsor-url-status-${formIndex}`);
                    if (statusElement) {
                        statusElement.innerHTML = '<span class="text-blue-600">üîÑ Testing URL...</span>';
                    }
                    
                    // Process embed input first
                    processEmbedInput(formIndex);
                    
                    // Then test the URL
                    setTimeout(() => {
                        // Try multiple selectors to find the hidden input
                        let hiddenUrlInput = document.querySelector(`input[name="sponsors-${formIndex}-logo_url"]`);
                        if (!hiddenUrlInput) {
                            hiddenUrlInput = document.getElementById(`sponsor-logo-url-final-${formIndex}`);
                        }
                        if (!hiddenUrlInput) {
                            hiddenUrlInput = document.querySelector(`input[name*="logo_url"][data-form-index="${formIndex}"]`);
                        }
                        if (!hiddenUrlInput) {
                            // For Django formsets, try to find by form prefix
                            hiddenUrlInput = document.querySelector(`#id_sponsors-${formIndex}-logo_url`);
                        }
                        
                        // Try multiple selectors for status element
                        let statusElement = document.querySelector(`.sponsor-url-status-${formIndex}`);
                        if (!statusElement) {
                            statusElement = document.getElementById(`sponsor-url-status-${formIndex}`);
                        }
                        
                        const previewElement = document.querySelector(`.sponsor-logo-preview-${formIndex}`);
                        const previewContainer = document.querySelector(`.sponsor-logo-preview-container-${formIndex}`);
                        
                        console.log('Elements search results:', {
                            hiddenUrlInput: !!hiddenUrlInput,
                            hiddenUrlInputId: hiddenUrlInput ? hiddenUrlInput.id : 'not found',
                            hiddenUrlInputName: hiddenUrlInput ? hiddenUrlInput.name : 'not found',
                            statusElement: !!statusElement,
                            statusElementClass: statusElement ? statusElement.className : 'not found',
                            previewElement: !!previewElement,
                            previewContainer: !!previewContainer
                        });
                        
                        // If we still can't find the status element, create one
                        if (!statusElement) {
                            const button = document.querySelector(`.test-sponsor-url[data-form-index="${formIndex}"]`);
                            if (button && button.parentNode) {
                                statusElement = document.createElement('div');
                                statusElement.className = `sponsor-url-status-${formIndex} text-xs mt-2`;
                                button.parentNode.appendChild(statusElement);
                                console.log('Created new status element');
                            }
                        }
                        
                        if (hiddenUrlInput && statusElement) {
                            const url = hiddenUrlInput.value;
                            console.log('URL to test:', url);
                            
                            if (!url || url.trim() === '') {
                                // Check if there's content in the textarea that hasn't been processed
                                const embedInput = document.getElementById(`sponsor-embed-input-${formIndex}`);
                                console.log('Embed input found:', !!embedInput, embedInput ? embedInput.value : 'none');
                                
                                if (embedInput && embedInput.value.trim()) {
                                    statusElement.innerHTML = '<span class="text-orange-600">‚ö†Ô∏è Processing URL... Please wait.</span>';
                                    // Try processing again
                                    processEmbedInput(formIndex);
                                    setTimeout(() => {
                                        const urlAfterProcessing = hiddenUrlInput.value;
                                        if (urlAfterProcessing) {
                                            testGoogleDriveUrl(urlAfterProcessing, statusElement, previewElement, previewContainer);
                                        } else {
                                            statusElement.innerHTML = '<span class="text-red-600">‚ùå Could not extract valid Google Drive URL. Please check your input.</span>';
                                        }
                                    }, 300);
                                } else {
                                    statusElement.innerHTML = '<span class="text-red-600">‚ùå No URL found. Please paste iframe code or URL first.</span>';
                                }
                                return;
                            }
                            
                            // Test the URL
                            testGoogleDriveUrl(url, statusElement, previewElement, previewContainer);
                        } else {
                            console.error('Could not find required elements for form index:', formIndex);
                            console.error('Available inputs on page:', Array.from(document.querySelectorAll('input')).map(i => ({ id: i.id, name: i.name, type: i.type })));
                            console.error('Available divs with sponsor-url-status:', Array.from(document.querySelectorAll('[class*="sponsor-url-status"]')).map(d => ({ className: d.className, id: d.id })));
                            
                            // Try to show error in any available status element
                            const anyStatusElement = document.querySelector(`[class*="sponsor-url-status-${formIndex}"]`) || 
                                                    document.querySelector(`#sponsor-url-status-${formIndex}`) ||
                                                    statusElement;
                            
                            if (anyStatusElement) {
                                anyStatusElement.innerHTML = '<span class="text-red-600">‚ùå Error: Could not find required form elements. Check console for details.</span>';
                            } else {
                                alert('Error: Could not find form elements for sponsor form ' + formIndex + '. Check browser console for details.');
                            }
                        }
                    }, 150);
                } else {
                    console.error('No form index found on button:', button);
                }
            }
        });
        
        // Banner URL testing
        const bannerUrlInput = document.getElementById('{{ form.banner_image_url.id_for_label }}');
        const bannerTestBtn = document.getElementById('test-banner-url');
        const bannerStatus = document.getElementById('banner-url-status');
        const bannerPreview = document.getElementById('banner-preview');
        const bannerPreviewContainer = document.getElementById('banner-preview-container');
        
        if (bannerTestBtn && bannerUrlInput) {
            bannerTestBtn.addEventListener('click', function(e) {
                e.preventDefault();
                testGoogleDriveUrl(
                    bannerUrlInput.value, 
                    bannerStatus, 
                    bannerPreview, 
                    bannerPreviewContainer
                );
            });
            
            // Auto-test on URL change
            bannerUrlInput.addEventListener('blur', function() {
                testGoogleDriveUrl(
                    this.value, 
                    bannerStatus, 
                    bannerPreview, 
                    bannerPreviewContainer
                );
            });
        }
        
        // Auto-test sponsor URLs on blur
        document.addEventListener('blur', function(e) {
            if (e.target.name && e.target.name.includes('logo_url')) {
                const formIndex = e.target.name.match(/sponsors-(\d+)-logo_url/);
                if (formIndex) {
                    const index = formIndex[1];
                    const statusElement = document.querySelector(`.sponsor-url-status-${index}`);
                    const previewElement = document.querySelector(`.sponsor-logo-preview-${index}`);
                    const previewContainer = document.querySelector(`.sponsor-logo-preview-container-${index}`);
                    
                    if (statusElement) {
                        testGoogleDriveUrl(
                            e.target.value, 
                            statusElement, 
                            previewElement, 
                            previewContainer
                        );
                    }
                }
            }
        }, true);

        // Sponsor confirmation functionality
        document.addEventListener('click', function(e) {
            if (e.target.closest('.confirm-sponsor-btn')) {
                e.preventDefault();
                const formIndex = e.target.closest('.confirm-sponsor-btn').dataset.formIndex;
                const sponsorForm = document.querySelector(`.sponsor-form[data-form-index="${formIndex}"]`);
                const statusElement = document.querySelector(`.sponsor-confirmation-status-${formIndex}`);
                
                // Validate sponsor form
                const sponsorName = sponsorForm.querySelector('input[name$="-sponsor_name"]');
                const logoUrl = sponsorForm.querySelector('input[name$="-logo_url"]');
                
                let isValid = true;
                let errors = [];
                
                if (!sponsorName.value.trim()) {
                    errors.push('Sponsor name is required');
                    isValid = false;
                }
                
                if (!logoUrl.value.trim()) {
                    errors.push('Logo URL is required');
                    isValid = false;
                } else {
                    // Validate Google Drive URL format
                    const fileId = extractGoogleDriveId(logoUrl.value);
                    if (!fileId) {
                        errors.push('Invalid Google Drive URL format');
                        isValid = false;
                    }
                }
                
                if (isValid) {
                    statusElement.innerHTML = '<span class="text-green-600 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>Sponsor details confirmed!</span>';
                    
                    // Add visual confirmation to the form
                    sponsorForm.classList.add('border-green-500', 'bg-green-50');
                    sponsorForm.classList.remove('bg-gray-50');
                    
                    // Change button appearance
                    const confirmBtn = e.target.closest('.confirm-sponsor-btn');
                    confirmBtn.innerHTML = `
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Confirmed ‚úì
                    `;
                    confirmBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    confirmBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    confirmBtn.disabled = true;
                } else {
                    statusElement.innerHTML = '<span class="text-red-600 flex items-center"><svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>Please fix the following errors: ' + errors.join(', ') + '</span>';
                }
            }
        });

        // Quick Add Ticket Type Modal
        const quickAddBtn = document.getElementById('quickAddTicketTypeBtn');
        const modal = document.getElementById('ticketTypeModal');
        const closeModal = document.getElementById('closeModal');
        const cancelModal = document.getElementById('cancelModal');
        const ticketTypeForm = document.getElementById('quickTicketTypeForm');
        
        if (quickAddBtn && modal) {
            quickAddBtn.addEventListener('click', function() {
                modal.classList.remove('hidden');
                // Focus on the first input
                setTimeout(() => {
                    document.getElementById('type_name').focus();
                }, 100);
            });
            
            [closeModal, cancelModal].forEach(btn => {
                if (btn) {
                    btn.addEventListener('click', function() {
                        modal.classList.add('hidden');
                        ticketTypeForm.reset();
                    });
                }
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    ticketTypeForm.reset();
                }
            });
            
            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    modal.classList.add('hidden');
                    ticketTypeForm.reset();
                }
            });
            
            // Handle ticket template image preview

            
            // Handle form submission via API
            ticketTypeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(ticketTypeForm);
                try {
                    const response = await fetch('/api/events/{{ event.id }}/ticket-types/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // Refresh the page to show the new ticket type
                        window.location.reload();
                    } else {
                        alert('Error: ' + result.message);
                    }
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            });
        }
        
        // Sponsor Management JavaScript
        let sponsorFormCount = 0;
        
        // Add sponsor functionality
        document.getElementById('add-sponsor-btn').addEventListener('click', function() {
            const container = document.getElementById('sponsors-container');
            const newSponsorForm = createSponsorForm(sponsorFormCount);
            container.appendChild(newSponsorForm);
            
            // Initialize iframe processing for the new form
            const newIndex = sponsorFormCount;
            setTimeout(() => {
                processEmbedInput(newIndex);
            }, 100);
            
            sponsorFormCount++;
            updateManagementForm();
            
            // Scroll to the new form and add a temporary highlight
            newSponsorForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            newSponsorForm.classList.add('border-blue-500', 'bg-blue-50');
            setTimeout(() => {
                newSponsorForm.classList.remove('border-blue-500', 'bg-blue-50');
                newSponsorForm.classList.add('bg-gray-50');
            }, 2000);
            
            // Show a small notification
            const btn = document.getElementById('add-sponsor-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Sponsor Added!
            `;
            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            }, 2000);
        });
        
        // Remove sponsor functionality
        document.addEventListener('click', function(e) {
            if (e.target.closest('.remove-sponsor')) {
                e.preventDefault();
                const formIndex = e.target.closest('.remove-sponsor').dataset.formIndex;
                const sponsorForm = document.querySelector(`.sponsor-form[data-form-index="${formIndex}"]`);
                
                // If this is an existing sponsor, mark it for deletion
                const deleteField = sponsorForm.querySelector('input[name$="-DELETE"]');
                if (deleteField) {
                    deleteField.checked = true;
                    sponsorForm.style.display = 'none';
                } else {
                    // If it's a new sponsor, just remove the form
                    sponsorForm.remove();
                }
                updateManagementForm();
            }
        });
        
        function createSponsorForm(index) {
            const div = document.createElement('div');
            div.className = 'sponsor-form border-2 border-gray-200 p-6 rounded-lg bg-gray-50 hover:border-gray-300 transition-colors';
            div.setAttribute('data-form-index', index);
            
            div.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-semibold text-gray-800 text-lg flex items-center">
                        <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path>
                        </svg>
                        Sponsor ${parseInt(index) + 1}
                    </h4>
                    <button type="button" class="text-red-600 hover:text-red-800 remove-sponsor p-2 rounded-full hover:bg-red-50 transition-colors" data-form-index="${index}" title="Remove Sponsor">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sponsor Name <span class="text-red-500">*</span></label>
                        <input type="text" name="sponsors-${index}-sponsor_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="Enter sponsor name">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                        <input type="number" name="sponsors-${index}-order" value="${parseInt(index) + 1}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="${parseInt(index) + 1}">
                        <p class="text-xs text-gray-500 mt-1">Lower numbers appear first (1, 2, 3...)</p>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Logo URL (Google Drive) <span class="text-red-500">*</span></label>
                    
                    <!-- Visible input for iframe code -->
                    <div class="mb-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">
                            Paste iframe code or direct URL:
                        </label>
                        <textarea 
                            id="sponsor-embed-input-${index}" 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" 
                            rows="3"
                            placeholder="Paste your Google Drive iframe code or direct URL here..."
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-1">
                            You can paste either the iframe code or direct Google Drive URL
                        </p>
                    </div>
                    
                    <!-- Hidden input that will be submitted -->
                    <input type="hidden" name="sponsors-${index}-logo_url" id="sponsor-logo-url-final-${index}" required>
                    
                    <div class="relative">
                        <button type="button" class="test-sponsor-url bg-blue-600 text-white px-3 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium transition-colors" data-form-index="${index}">
                            Test URL
                        </button>
                    </div>
                    <div id="url-extraction-status-${index}" class="text-xs mt-2"></div>
                    <div class="sponsor-url-status-${index} text-xs mt-2"></div>
                    
                    <!-- Logo preview -->
                    <div class="sponsor-logo-preview-container-${index} mt-3 hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">Preview:</p>
                        <img class="sponsor-logo-preview-${index} h-16 rounded-lg border border-gray-200 shadow-sm" src="" alt="Logo preview">
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Website URL (Optional)</label>
                    <input type="url" name="sponsors-${index}-website_url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="https://sponsor-website.com (optional)">
                    <p class="text-xs text-gray-500 mt-1">Sponsor's website link (makes logo clickable)</p>
                </div>
                
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Sponsor Type</label>
                    <input type="text" name="sponsors-${index}-sponsor_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" placeholder="e.g., Ticketing Partner, Gold Sponsor, Venue Partner">
                    <p class="text-xs text-gray-500 mt-1">Specify the type of sponsorship (e.g., Ticketing Partner, Gold Sponsor, Venue Partner)</p>
                </div>
                
                <!-- Sponsor Confirmation Button -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <button type="button" class="confirm-sponsor-btn bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 text-sm font-medium flex items-center transition-colors shadow-sm" data-form-index="${index}">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Confirm Sponsor Details
                    </button>
                    <div class="sponsor-confirmation-status-${index} text-xs mt-2"></div>
                </div>
                
                <input type="hidden" name="sponsors-${index}-id" value="">
                <input type="hidden" name="sponsors-${index}-DELETE" value="">
            `;
            
            return div;
        }
        
        function updateManagementForm() {
            const managementForm = document.querySelector('input[name="sponsors-TOTAL_FORMS"]');
            if (managementForm) {
                managementForm.value = sponsorFormCount;
            } else {
                // Create management form if it doesn't exist
                const eventForm = document.getElementById('eventForm');
                const managementHtml = `
                    <input type="hidden" name="sponsors-TOTAL_FORMS" value="${sponsorFormCount}">
                    <input type="hidden" name="sponsors-INITIAL_FORMS" value="0">
                    <input type="hidden" name="sponsors-MIN_NUM_FORMS" value="0">
                    <input type="hidden" name="sponsors-MAX_NUM_FORMS" value="1000">
                `;
                eventForm.insertAdjacentHTML('afterbegin', managementHtml);
            }
        }
        
        // Initialize management form for new events
        '{% if not sponsor_formset %}'
            updateManagementForm();
        '{% endif %}'
        
        // Iframe parsing functionality
        function extractUrlFromInput(input) {
            if (!input) return null;
            
            // First, check if it's an iframe
            const iframeMatch = input.match(/<iframe[^>]*src="([^"]*)"[^>]*>/i);
            if (iframeMatch) {
                return iframeMatch[1]; // Return the src URL
            }
            
            // If not iframe, check if it's a direct URL
            const urlPattern = /https?:\/\/[^\s<>"]+/i;
            const urlMatch = input.match(urlPattern);
            if (urlMatch) {
                return urlMatch[0];
            }
            
            return null;
        }
        
        function validateGoogleDriveUrl(url) {
            const googleDrivePatterns = [
                /drive\.google\.com\/file\/d\/([a-zA-Z0-9-_]+)/,
                /drive\.google\.com\/open\?id=([a-zA-Z0-9-_]+)/,
                /googleusercontent\.com/
            ];
            
            return googleDrivePatterns.some(pattern => pattern.test(url));
        }
        
        function extractFileId(url) {
            const patterns = [
                /\/d\/([a-zA-Z0-9-_]+)/,  // /file/d/FILE_ID/
                /id=([a-zA-Z0-9-_]+)/,    // ?id=FILE_ID
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }
        
        function processEmbedInput(index) {
            const embedInput = document.getElementById(`sponsor-embed-input-${index}`);
            const hiddenUrlInput = document.querySelector(`input[name="sponsors-${index}-logo_url"]`);
            const statusElement = document.getElementById(`url-extraction-status-${index}`);
            const testStatusElement = document.querySelector(`.sponsor-url-status-${index}`);
            const previewElement = document.querySelector(`.sponsor-logo-preview-${index}`);
            const previewContainer = document.querySelector(`.sponsor-logo-preview-container-${index}`);
            
            if (!embedInput || !hiddenUrlInput) {
                console.log('Could not find required elements for index:', index);
                return;
            }
            
            const inputValue = embedInput.value.trim();
            
            if (!inputValue) {
                hiddenUrlInput.value = '';
                if (statusElement) statusElement.innerHTML = '';
                if (testStatusElement) testStatusElement.innerHTML = '';
                if (previewContainer) previewContainer.classList.add('hidden');
                return;
            }
            
            const extractedUrl = extractUrlFromInput(inputValue);
            
            if (extractedUrl) {
                if (validateGoogleDriveUrl(extractedUrl)) {
                    hiddenUrlInput.value = extractedUrl;
                    if (statusElement) {
                        statusElement.innerHTML = '<span class="text-green-600">‚úÖ URL extracted successfully</span>';
                    }
                    
                    // Automatically test the extracted URL
                    if (testStatusElement && previewElement && previewContainer) {
                        testGoogleDriveUrl(extractedUrl, testStatusElement, previewElement, previewContainer);
                    }
                } else {
                    hiddenUrlInput.value = '';
                    if (statusElement) {
                        statusElement.innerHTML = '<span class="text-red-600">‚ùå Not a valid Google Drive URL</span>';
                    }
                    if (previewContainer) previewContainer.classList.add('hidden');
                }
            } else {
                hiddenUrlInput.value = '';
                if (statusElement) {
                    statusElement.innerHTML = '<span class="text-red-600">‚ùå Could not extract URL from input</span>';
                }
                if (previewContainer) previewContainer.classList.add('hidden');
            }
        }
        
        // Event delegation for iframe processing (for both existing and new forms)
        document.addEventListener('input', function(e) {
            if (e.target.id && e.target.id.startsWith('sponsor-embed-input-')) {
                const index = e.target.id.replace('sponsor-embed-input-', '');
                processEmbedInput(index);
            }
        });
        
        document.addEventListener('paste', function(e) {
            if (e.target.id && e.target.id.startsWith('sponsor-embed-input-')) {
                const index = e.target.id.replace('sponsor-embed-input-', '');
                // Small delay to allow paste content to be processed
                setTimeout(() => processEmbedInput(index), 100);
            }
        });
        
        document.addEventListener('blur', function(e) {
            if (e.target.id && e.target.id.startsWith('sponsor-embed-input-')) {
                const index = e.target.id.replace('sponsor-embed-input-', '');
                processEmbedInput(index);
            }
        });
        
        // Initialize existing sponsor forms (for edit mode)
        {% for sponsor_form in sponsor_formset %}
            (function() {
                const index = '{{ forloop.counter0 }}';
                const existingUrl = '{{ sponsor_form.logo_url.value|default:"" }}';
                const embedInput = document.getElementById('sponsor-embed-input-' + index);
                
                if (existingUrl && embedInput) {
                    embedInput.value = existingUrl;
                    setTimeout(() => {
                        processEmbedInput(index);
                    }, 100);
                } else if (embedInput && !existingUrl) {
                    // For empty forms, still initialize the functionality
                    setTimeout(() => {
                        processEmbedInput(index);
                    }, 100);
                }
            })();
        {% endfor %}
        
    });
</script>
{% endblock %}
